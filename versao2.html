<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controle de Horas de Estágio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      ::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }
      .day-disabled {
        background-color: #f8fafc;
        color: #cbd5e1;
        pointer-events: none;
      }
      .day-weekend {
        background-color: #f1f5f9;
        color: #94a3b8;
      }
      #notification {
        transition: opacity 0.5s, transform 0.5s;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800">
    <!-- Notification element -->
    <div
      id="notification"
      class="fixed top-5 right-5 bg-red-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-[-20px] pointer-events-none z-50"
    >
      <p id="notification-message"></p>
    </div>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-slate-900">Meu Controle de Horas</h1>
        <p class="text-slate-500 mt-1">
          Olá, Mari! Organize suas horas de estágio de forma simples.
        </p>
        <div id="auth-info" class="mt-2 text-xs text-slate-400">
          <p class="font-semibold text-slate-600">
            Dados salvos no Google Sheets.
          </p>
        </div>
      </header>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
          <h2 class="text-sm font-semibold text-slate-500">Balanço do Mês</h2>
          <p
            id="monthly-balance"
            class="text-2xl font-bold text-slate-800 mt-2"
          >
            - / -
          </p>
          <div class="w-full bg-slate-200 rounded-full h-2.5 mt-3">
            <div
              id="monthly-progress"
              class="bg-blue-600 h-2.5 rounded-full"
              style="width: 0%"
            ></div>
          </div>
          <p
            id="monthly-status"
            class="text-sm font-medium mt-2 text-slate-600"
          >
            &nbsp;
          </p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
          <h2 class="text-sm font-semibold text-slate-500">
            Balanço da Semana
          </h2>
          <p id="weekly-balance" class="text-2xl font-bold text-slate-800 mt-2">
            - / -
          </p>
          <div class="w-full bg-slate-200 rounded-full h-2.5 mt-3">
            <div
              id="weekly-progress"
              class="bg-violet-600 h-2.5 rounded-full"
              style="width: 0%"
            ></div>
          </div>
          <p id="weekly-status" class="text-sm font-medium mt-2 text-slate-600">
            &nbsp;
          </p>
        </div>
      </div>

      <div
        class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border border-slate-200"
      >
        <div class="flex items-center justify-between mb-4">
          <button
            id="prev-month"
            class="p-2 rounded-md hover:bg-slate-100 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M15 18l-6-6 6-6" />
            </svg>
          </button>
          <h2
            id="current-month-year"
            class="text-lg font-bold text-slate-900"
          ></h2>
          <button
            id="next-month"
            class="p-2 rounded-md hover:bg-slate-100 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M9 18l6-6-6-6" />
            </svg>
          </button>
        </div>
        <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
      </div>
    </div>

    <div
      id="entry-modal"
      class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50"
    >
      <div
        class="bg-white rounded-2xl shadow-xl w-full max-w-md transform transition-all"
      >
        <div class="p-6 border-b border-slate-200">
          <h3 class="text-lg font-bold">
            Lançar Horas - <span id="modal-date"></span>
          </h3>
          <p class="text-sm text-slate-500">
            Escolha como prefere registrar suas horas.
          </p>
        </div>
        <div class="p-6">
          <div class="mb-4 border-b border-gray-200">
            <ul
              class="flex flex-wrap -mb-px text-sm font-medium text-center"
              id="modal-tabs"
            >
              <li class="mr-2">
                <button
                  class="tab-btn inline-block p-4 border-b-2 rounded-t-lg"
                  data-tab="automatic"
                >
                  Cálculo Automático
                </button>
              </li>
              <li class="mr-2">
                <button
                  class="tab-btn inline-block p-4 border-b-2 rounded-t-lg"
                  data-tab="manual"
                >
                  Entrada Manual
                </button>
              </li>
            </ul>
          </div>
          <div id="automatic-tab" class="tab-content">
            <form id="automatic-form">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label
                    for="start-time"
                    class="block text-sm font-medium text-slate-700"
                    >Hora de Chegada</label
                  ><input
                    type="time"
                    id="start-time"
                    class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label
                    for="end-time"
                    class="block text-sm font-medium text-slate-700"
                    >Hora de Saída</label
                  ><input
                    type="time"
                    id="end-time"
                    class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  />
                </div>
              </div>
              <div class="mt-4">
                <label
                  for="lunch-minutes"
                  class="block text-sm font-medium text-slate-700"
                  >Almoço (em minutos)</label
                ><input
                  type="number"
                  id="lunch-minutes"
                  value="60"
                  class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                />
              </div>
            </form>
          </div>
          <div id="manual-tab" class="tab-content hidden">
            <form id="manual-form">
              <div>
                <label
                  for="manual-hours"
                  class="block text-sm font-medium text-slate-700"
                  >Horas Trabalhadas (Ex: 6:30)</label
                ><input
                  type="text"
                  id="manual-hours"
                  placeholder="HH:MM"
                  class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                />
              </div>
            </form>
          </div>
        </div>
        <div
          class="px-6 py-4 bg-slate-50 rounded-b-2xl flex justify-between items-center"
        >
          <button
            id="delete-entry"
            type="button"
            class="text-sm font-semibold text-red-600 hover:text-red-800"
          >
            Excluir Lançamento
          </button>
          <div>
            <button
              id="cancel-modal"
              type="button"
              class="px-4 py-2 text-sm font-semibold text-slate-700 bg-white rounded-md border border-slate-300 hover:bg-slate-50 mr-2"
            >
              Cancelar
            </button>
            <button
              id="save-entry"
              type="button"
              class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700"
            >
              Salvar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // --- CONFIGURATION ---
      // COLE AQUI O URL DO SEU APP DA WEB DO GOOGLE APPS SCRIPT
      const GOOGLE_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbycBeh3s6WSk2d0UIxCUzinFdBU6oLNfFI5xuuwDtvRKrZiojtFhP5R2HzkT7uJ4i6j5w/exec";

      // App State
      const state = {
        currentDate: new Date(),
        selectedDay: null,
        monthlyData: {},
        activeTab: "automatic",
        isLoading: false,
      };
      const DAILY_GOAL_MINUTES = 6 * 60;
      const WEEKLY_GOAL_MINUTES = DAILY_GOAL_MINUTES * 5;

      // UI Elements
      const DOMElements = {
        notification: document.getElementById("notification"),
        notificationMessage: document.getElementById("notification-message"),
        prevMonthBtn: document.getElementById("prev-month"),
        nextMonthBtn: document.getElementById("next-month"),
        currentMonthYear: document.getElementById("current-month-year"),
        calendarGrid: document.getElementById("calendar-grid"),
        entryModal: document.getElementById("entry-modal"),
        modalDate: document.getElementById("modal-date"),
        cancelModalBtn: document.getElementById("cancel-modal"),
        saveEntryBtn: document.getElementById("save-entry"),
        deleteEntryBtn: document.getElementById("delete-entry"),
        tabs: document.querySelectorAll(".tab-btn"),
        tabContents: document.querySelectorAll(".tab-content"),
        automaticForm: {
          start: document.getElementById("start-time"),
          end: document.getElementById("end-time"),
          lunch: document.getElementById("lunch-minutes"),
        },
        manualForm: { hours: document.getElementById("manual-hours") },
        summary: {
          monthlyBalance: document.getElementById("monthly-balance"),
          monthlyProgress: document.getElementById("monthly-progress"),
          monthlyStatus: document.getElementById("monthly-status"),
          weeklyBalance: document.getElementById("weekly-balance"),
          weeklyProgress: document.getElementById("weekly-progress"),
          weeklyStatus: document.getElementById("weekly-status"),
        },
      };

      // --- UTILITY FUNCTIONS ---
      const minutesToHHMM = (totalMinutes) => {
        if (isNaN(totalMinutes)) return "0:00";
        const sign = totalMinutes < 0 ? "-" : "";
        const absMinutes = Math.abs(totalMinutes);
        const hours = Math.floor(absMinutes / 60);
        const minutes = absMinutes % 60;
        return `${sign}${hours}h ${String(minutes).padStart(2, "0")}m`;
      };

      const HMMToMinutes = (timeStr) => {
        if (!timeStr || !timeStr.includes(":")) return 0;
        const [hours, minutes] = timeStr.split(":").map(Number);
        return hours * 60 + minutes;
      };

      const getWeekNumber = (d) => {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        var weekNo = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
        return weekNo;
      };

      const showNotification = (message, isError = true, duration = 3000) => {
        DOMElements.notificationMessage.textContent = message;
        DOMElements.notification.classList.toggle("bg-red-600", isError);
        DOMElements.notification.classList.toggle("bg-green-600", !isError);
        DOMElements.notification.classList.remove(
          "opacity-0",
          "translate-y-[-20px]"
        );

        setTimeout(() => {
          DOMElements.notification.classList.add(
            "opacity-0",
            "translate-y-[-20px]"
          );
        }, duration);
      };

      // --- GOOGLE SHEETS DATA HANDLING ---
      const fetchMonthlyData = async () => {
        if (GOOGLE_SCRIPT_URL === "COLE_AQUI_O_URL") {
          showNotification("Configure o URL do Google Apps Script primeiro!");
          return;
        }
        state.isLoading = true;
        const year = state.currentDate.getFullYear();
        const month = state.currentDate.getMonth();
        const url = `${GOOGLE_SCRIPT_URL}?year=${year}&month=${month}`;

        try {
          const response = await fetch(url);
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();
          if (data.error) throw new Error(data.error);

          state.monthlyData = data.days || {};
          renderCalendar();
          updateSummaries();
        } catch (error) {
          console.error("Error fetching data:", error);
          showNotification("Erro ao buscar dados da planilha.");
          state.monthlyData = {}; // Clear data on error
          renderCalendar();
          updateSummaries();
        } finally {
          state.isLoading = false;
        }
      };

      const saveData = async (action, data) => {
        if (GOOGLE_SCRIPT_URL === "COLE_AQUI_O_URL") {
          showNotification("Configure o URL do Google Apps Script primeiro!");
          return;
        }
        state.isLoading = true;
        try {
          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors", // Required for simple POST requests to Apps Script
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action, data }),
          });
          // no-cors means we can't read the response, so we just assume it worked
          // and refetch the data to update the UI
          showNotification(
            action === "save"
              ? "Dados salvos com sucesso!"
              : "Lançamento excluído!",
            false
          );
          await fetchMonthlyData();
        } catch (error) {
          console.error("Error saving data:", error);
          showNotification("Erro ao salvar dados.");
        } finally {
          state.isLoading = false;
          closeModal();
        }
      };

      // --- UI RENDERING ---
      const renderCalendar = () => {
        const date = state.currentDate;
        const year = date.getFullYear();
        const month = date.getMonth();

        DOMElements.currentMonthYear.textContent = date.toLocaleDateString(
          "pt-BR",
          { month: "long", year: "numeric" }
        );
        DOMElements.calendarGrid.innerHTML = "";

        ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"].forEach((day) => {
          const dayEl = document.createElement("div");
          dayEl.className =
            "text-center font-semibold text-sm text-slate-500 pb-2";
          dayEl.textContent = day;
          DOMElements.calendarGrid.appendChild(dayEl);
        });

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++)
          DOMElements.calendarGrid.appendChild(
            document.createElement("div")
          ).className = "day-disabled";

        for (let i = 1; i <= daysInMonth; i++) {
          const dayContainer = document.createElement("div");
          const fullDate = new Date(year, month, i);
          const dayOfWeek = fullDate.getDay();
          const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

          dayContainer.className = `day-cell p-2 border border-slate-200 rounded-lg text-center cursor-pointer transition-colors hover:bg-blue-50 flex flex-col justify-between h-24 sm:h-28`;
          if (isWeekend) dayContainer.classList.add("day-weekend");
          dayContainer.dataset.day = i;

          const dayNumber = document.createElement("span");
          dayNumber.className = "font-semibold";
          dayNumber.textContent = i;
          dayContainer.appendChild(dayNumber);

          const dayData = state.monthlyData[i];
          const workedMinutes = dayData ? HMMToMinutes(dayData.worked) : 0;

          const timeWorkedEl = document.createElement("span");
          timeWorkedEl.className = "text-lg font-bold mt-1";
          if (dayData) {
            timeWorkedEl.textContent = minutesToHHMM(workedMinutes)
              .replace("h ", ":")
              .replace("m", "");
            if (
              !isWeekend &&
              workedMinutes > 0 &&
              workedMinutes < DAILY_GOAL_MINUTES
            )
              timeWorkedEl.classList.add("text-amber-600");
            else if (!isWeekend && workedMinutes > 0)
              timeWorkedEl.classList.add("text-green-600");
          } else {
            timeWorkedEl.textContent = "-";
            timeWorkedEl.classList.add("text-slate-400");
          }
          dayContainer.appendChild(timeWorkedEl);
          dayContainer.onclick = () => openModal(i);
          DOMElements.calendarGrid.appendChild(dayContainer);
        }
      };

      const updateSummaries = () => {
        const year = state.currentDate.getFullYear();
        const month = state.currentDate.getMonth();
        const today = new Date();
        const currentWeek = getWeekNumber(today);
        let totalMinutesMonth = 0,
          totalMinutesWeek = 0,
          workdaysInMonth = 0,
          workdaysInWeek = 0;

        for (const day in state.monthlyData) {
          const date = new Date(year, month, parseInt(day));
          if (date.getDay() !== 0 && date.getDay() !== 6) {
            const minutes = HMMToMinutes(state.monthlyData[day].worked);
            totalMinutesMonth += minutes;
            if (getWeekNumber(date) === currentWeek)
              totalMinutesWeek += minutes;
          }
        }

        for (let i = 1; i <= new Date(year, month + 1, 0).getDate(); i++) {
          const date = new Date(year, month, i);
          if (date.getDay() !== 0 && date.getDay() !== 6) {
            workdaysInMonth++;
            if (getWeekNumber(date) === currentWeek) workdaysInWeek++;
          }
        }

        const requiredMinutesMonth = workdaysInMonth * DAILY_GOAL_MINUTES;
        const requiredMinutesWeek = workdaysInWeek * DAILY_GOAL_MINUTES;

        // Monthly Summary
        DOMElements.summary.monthlyBalance.textContent = `${minutesToHHMM(
          totalMinutesMonth
        )} / ${minutesToHHMM(requiredMinutesMonth)}`;
        const monthlyProgressPercent =
          requiredMinutesMonth > 0
            ? (totalMinutesMonth / requiredMinutesMonth) * 100
            : 0;
        DOMElements.summary.monthlyProgress.style.width = `${Math.min(
          100,
          monthlyProgressPercent
        )}%`;
        const monthBalance = totalMinutesMonth - requiredMinutesMonth;
        DOMElements.summary.monthlyStatus.textContent =
          monthBalance >= 0
            ? `Você tem ${minutesToHHMM(monthBalance)} de crédito.`
            : `Você deve ${minutesToHHMM(Math.abs(monthBalance))}.`;
        DOMElements.summary.monthlyStatus.className = `text-sm font-medium mt-2 ${
          monthBalance >= 0 ? "text-green-600" : "text-amber-600"
        }`;

        // Weekly Summary
        DOMElements.summary.weeklyBalance.textContent = `${minutesToHHMM(
          totalMinutesWeek
        )} / ${minutesToHHMM(requiredMinutesWeek)}`;
        const weeklyProgressPercent =
          requiredMinutesWeek > 0
            ? (totalMinutesWeek / requiredMinutesWeek) * 100
            : 0;
        DOMElements.summary.weeklyProgress.style.width = `${Math.min(
          100,
          weeklyProgressPercent
        )}%`;
        const weekBalance = totalMinutesWeek - requiredMinutesWeek;
        DOMElements.summary.weeklyStatus.textContent =
          weekBalance >= 0
            ? `Você tem ${minutesToHHMM(weekBalance)} de crédito.`
            : `Você deve ${minutesToHHMM(Math.abs(weekBalance))}.`;
        DOMElements.summary.weeklyStatus.className = `text-sm font-medium mt-2 ${
          weekBalance >= 0 ? "text-green-600" : "text-amber-600"
        }`;
      };

      // --- MODAL LOGIC ---
      const openModal = (day) => {
        state.selectedDay = day;
        const date = new Date(
          state.currentDate.getFullYear(),
          state.currentDate.getMonth(),
          day
        );
        DOMElements.modalDate.textContent = date.toLocaleDateString("pt-BR", {
          day: "2-digit",
          month: "long",
        });

        DOMElements.automaticForm.start.value = "";
        DOMElements.automaticForm.end.value = "";
        DOMElements.automaticForm.lunch.value = "60";
        DOMElements.manualForm.hours.value = "";

        const dayData = state.monthlyData[day];
        if (dayData) {
          if (dayData.mode === "automatic") {
            DOMElements.automaticForm.start.value = dayData.start;
            DOMElements.automaticForm.end.value = dayData.end;
            DOMElements.automaticForm.lunch.value = dayData.lunch;
            switchTab("automatic");
          } else {
            DOMElements.manualForm.hours.value = dayData.worked;
            switchTab("manual");
          }
          DOMElements.deleteEntryBtn.classList.remove("hidden");
        } else {
          switchTab("automatic");
          DOMElements.deleteEntryBtn.classList.add("hidden");
        }
        DOMElements.entryModal.classList.remove("hidden");
      };

      const closeModal = () => {
        DOMElements.entryModal.classList.add("hidden");
        state.selectedDay = null;
      };

      const switchTab = (tabName) => {
        state.activeTab = tabName;
        DOMElements.tabs.forEach((tab) =>
          tab.classList.toggle("border-blue-600", tab.dataset.tab === tabName)
        );
        DOMElements.tabs.forEach((tab) =>
          tab.classList.toggle("text-blue-600", tab.dataset.tab === tabName)
        );
        DOMElements.tabContents.forEach((content) =>
          content.classList.toggle("hidden", content.id !== `${tabName}-tab`)
        );
      };

      const handleSave = () => {
        const date = new Date(
          state.currentDate.getFullYear(),
          state.currentDate.getMonth(),
          state.selectedDay
        );
        const dateString = `${date.getFullYear()}-${String(
          date.getMonth() + 1
        ).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
        let dataToSave;

        if (state.activeTab === "automatic") {
          const start = DOMElements.automaticForm.start.value,
            end = DOMElements.automaticForm.end.value;
          if (!start || !end) {
            showNotification("Preencha a hora de chegada e saída.");
            return;
          }
          if (HMMToMinutes(end) < HMMToMinutes(start)) {
            showNotification("A hora de saída deve ser depois da chegada.");
            return;
          }

          const lunch = parseInt(DOMElements.automaticForm.lunch.value) || 0;
          const workedMinutes = HMMToMinutes(end) - HMMToMinutes(start) - lunch;
          dataToSave = {
            date: dateString,
            worked: minutesToHHMM(workedMinutes)
              .replace("h ", ":")
              .replace("m", ""),
            mode: "automatic",
            start,
            end,
            lunch,
          };
        } else {
          const manualHours = DOMElements.manualForm.hours.value;
          if (!/^\d{1,2}:\d{2}$/.test(manualHours)) {
            showNotification("Use o formato HH:MM.");
            return;
          }
          dataToSave = {
            date: dateString,
            worked: manualHours,
            mode: "manual",
          };
        }
        saveData("save", dataToSave);
      };

      const handleDelete = () => {
        if (confirm("Tem certeza que deseja excluir este lançamento?")) {
          const date = new Date(
            state.currentDate.getFullYear(),
            state.currentDate.getMonth(),
            state.selectedDay
          );
          const dateString = `${date.getFullYear()}-${String(
            date.getMonth() + 1
          ).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
          saveData("delete", { date: dateString });
        }
      };

      // --- EVENT LISTENERS ---
      DOMElements.prevMonthBtn.onclick = () => {
        state.currentDate.setMonth(state.currentDate.getMonth() - 1);
        fetchMonthlyData();
      };
      DOMElements.nextMonthBtn.onclick = () => {
        state.currentDate.setMonth(state.currentDate.getMonth() + 1);
        fetchMonthlyData();
      };
      DOMElements.cancelModalBtn.onclick = closeModal;
      DOMElements.saveEntryBtn.onclick = handleSave;
      DOMElements.deleteEntryBtn.onclick = handleDelete;
      DOMElements.tabs.forEach(
        (tab) => (tab.onclick = () => switchTab(tab.dataset.tab))
      );
      window.onkeydown = (e) => {
        if (e.key === "Escape") closeModal();
      };

      // Initial Load
      fetchMonthlyData();
    </script>
  </body>
</html>
